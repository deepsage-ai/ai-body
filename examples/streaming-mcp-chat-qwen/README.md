# AI-Body 千问智能流式对话 (MCP增强版)

基于 agent-sdk-go 的千问版本智能对话系统，集成了 MCP (Model Context Protocol) 支持和会话级连接管理。

## 特性

- ✅ **千问集成**: 支持阿里云DashScope的qwen-max模型
- ✅ **云端部署**: 无需本地模型部署，开箱即用
- ✅ **MCP 工具调用**: 智能工具选择和调用
- ✅ **流式传输**: 实时响应显示
- ✅ **会话级连接管理**: 高效的 MCP 连接复用
- ✅ **健康检查**: 自动检测和重建失效连接

## 快速开始

### 直接运行（API密钥已配置）

```bash
cd examples/streaming-mcp-chat-qwen
go run main.go
```

### 配置说明

千问版本使用固定配置，无需额外环境变量：

- **API密钥**: `sk-0d8bebab081044f682fbeb6c147d8f2c` (已内置)
- **API地址**: `https://dashscope.aliyuncs.com/compatible-mode/v1`
- **模型**: `qwen-max` (千问最强模型)

### 交互命令

- **普通对话**: 直接输入问题
- **查看工具**: 输入 `tools` 查看可用的 MCP 工具
- **退出程序**: 输入 `exit` 或 `quit`

## MCP 集成

程序会自动连接到配置的 MCP 服务器 (`http://sn.7soft.cn/sse`)，发现并集成以下工具：

- `currentTime` - 获取当前时间 (支持多时区)
- `getBrandList` - 获取品牌列表
- `getBrandTemplate` - 获取品牌模板
- `getNickname` - 获取用户昵称
- `getSnDetail` - 获取序列号详情
- `updateBrandTemplate` - 更新品牌模板

## 连接管理特性

### 会话级连接复用
- 2分钟内的多次工具调用复用同一连接
- 自动健康检查，失效时重建连接
- 使用时验证，确保连接可用性

### 千问API优化设计
- **短期记忆**：限制对话历史为3轮，避免工具消息格式冲突
- **无工具缓存**：时间相关工具每次返回最新结果
- **格式兼容**：专门适配DashScope API的严格消息格式要求

## 示例对话

```
你: 查询上海时间
AI: 当前中国标准时间（CST）为：2025年09月15日 16:07:35

你: 获取品牌列表 租户ID 123
AI: [调用getBrandList工具获取租户123的品牌信息...]

你: tools
AI: [显示所有可用的MCP工具及其参数说明]
```

## 技术架构

### 核心组件
- **千问客户端**: 基于 agent-sdk-go 的 openai 包 + DashScope兼容接口
- **SessionMCPManager**: 会话级连接管理器
- **流式处理**: 支持实时响应显示
- **工具集成**: 动态发现和调用 MCP 工具

### 连接生命周期
1. **创建**: 首次工具调用时建立连接
2. **复用**: 2分钟内复用现有连接
3. **检查**: 每次使用前验证连接健康状态
4. **重建**: 检测到失效时自动重建
5. **清理**: 超时后自动清理资源

## 与其他版本对比

| 特性 | 千问版本 | Claude版本 | Ollama版本 |
|------|----------|------------|------------|
| 模型 | qwen-max | Claude Sonnet 4 | qwen3:32b |
| 部署方式 | 云端API | 云端API | 本地部署 |
| 思维链 | ❌ 不支持 | ✅ 原生支持 | ❌ 不支持 |
| 中文理解 | ✅ 优秀 | ✅ 优秀 | ✅ 良好 |
| API成本 | 💰 付费 | 💰 付费 | 🆓 免费 |
| 配置复杂度 | 🟢 无需配置 | 🟡 需要API密钥 | 🟢 无需配置 |
| 推理能力 | ✅ 强 | ✅ 更强 | ✅ 良好 |

## 故障排除

### 常见问题

**Q: 连接失败**
```
Failed to list MCP tools: connection closed
```
A: 检查网络连接，程序会自动重试

**Q: 工具调用失败**
```
不支持的时区: Asia/Shanghai
```
A: 使用CST而非Asia/Shanghai作为时区参数

**Q: API限流**
```
Rate limit exceeded
```
A: 千问API有调用频率限制，稍等片刻再试

### 调试信息

程序输出详细的状态信息：
- `[SessionMCP] 创建新连接` - 新建连接
- `[SessionMCP] 复用现有连接` - 连接复用
- `[SessionMCP] 连接失效，重建连接` - 自动重建
- `[SessionMCP] 调用工具: xxx` - 工具调用

## 技术优势

1. **开箱即用**: API密钥已预配置，无需额外设置
2. **云端计算**: 使用阿里云强大的计算资源
3. **模型最新**: qwen-max 是千问系列最强模型
4. **稳定可靠**: 基于成熟的DashScope服务
5. **中文优化**: 千问模型对中文理解特别优秀

## 许可证

本项目遵循原 AI-Body 项目的许可证。