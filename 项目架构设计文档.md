# AI-Body 企业微信智能机器人架构设计文档

## 1. 项目概述

### 1.1 项目背景
AI-Body是一个基于Go语言的企业微信智能机器人项目，采用agent-sdk-go框架作为核心智能体引擎。项目专注于为企业微信用户提供智能对话服务，支持多大语言模型、集成外部MCP服务器、具备简单工作流能力。

### 1.2 项目定位
- **企业微信机器人**：专为企业微信平台设计的智能对话机器人
- **MCP客户端**：作为MCP协议客户端，连接和使用外部MCP服务器提供的工具
- **多模型支持**：统一接口支持Qwen、DeepSeek、Ollama等多种大语言模型
- **简单架构**：单一HTTP回调接口，配置文件驱动的简化架构

### 1.3 核心目标
- **企业微信集成**：完整支持企业微信消息回调和安全验证机制
- **多模型统一接入**：通过适配器模式支持多种LLM提供商
- **MCP外部工具集成**：自动发现和使用外部MCP服务器的工具、资源和提示词
- **智能决策能力**：大模型自动判断是否需要调用外部工具
- **简洁工作流**：三步式工作流（决策→工具调用→响应生成）

### 1.4 技术选型

| 组件 | 技术栈 | 版本 | 说明 |
|------|--------|------|------|
| 编程语言 | Go | 1.21+ | 主要开发语言 |
| 智能体框架 | agent-sdk-go | latest | 核心智能体引擎 |
| 协议标准 | MCP | 2024-11-05 | Model Context Protocol客户端实现 |
| 配置管理 | Viper | v1.17+ | 配置文件解析 |
| 日志框架 | Zap | v1.26+ | 结构化日志 |
| HTTP框架 | Gin | v1.9+ | 企业微信回调服务 |
| 消息格式 | XML | - | 企业微信消息格式 |

## 2. 整体架构设计

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                AI-Body 企业微信智能机器人                     │
├─────────────────────────────────────────────────────────────┤
│              企业微信 HTTP 回调接口                          │
│              (消息接收/验证/回复)                            │
├─────────────────────────────────────────────────────────────┤
│      Agent Core     │  Simple Workflow  │  Session Manager │
├─────────────────────┼─────────────────────┼─────────────────┤
│               Agent-SDK-GO Framework                       │
├─────────────────────────────────────────────────────────────┤
│    LLM Adapters     │    Memory Store    │   MCP Client    │
├─────────────────────┼────────────────────┼─────────────────┤
│ Qwen│DeepSeek│Ollama│  Conversation Buf  │  Tool Registry  │
├─────────────────────┼────────────────────┼─────────────────┤
│                     External MCP Servers                   │
│           (FileSystem│Database│Weather│Custom...)           │
├─────────────────────────────────────────────────────────────┤
│                        企业微信平台                         │
│                    (消息推送/用户管理)                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 项目目录结构

```
ai-body/
├── main.go                            # 应用程序入口（根目录）
├── config/
│   ├── app.yaml                       # 应用主配置
│   ├── llm.yaml                       # LLM配置
│   ├── mcp.json                       # MCP服务器配置
│   └── workflow.yaml                  # 工作流配置

│   llm/                           # LLM适配层
│   │   ├── interface.go               # LLM接口定义
│   │   ├── factory.go                 # LLM工厂
│   │   ├── qwen.go                    # Qwen适配器
│   │   ├── deepseek.go                # DeepSeek适配器
│   │   └── ollama.go                  # Ollama适配器
│   ├── mcp/                           # MCP客户端实现
│   │   ├── client/                    # MCP客户端
│   │   │   ├── client.go              # 客户端核心
│   │   │   ├── transport.go           # 传输层
│   │   │   └── discovery.go           # 发现服务
│   │   ├── protocol/                  # MCP协议实现
│   │   │   ├── messages.go            # 消息定义
│   │   │   ├── capability.go          # 能力协商
│   │   │   └── lifecycle.go           # 生命周期
│   │   └── registry/                  # 工具注册中心
│   │       ├── tool_registry.go       # 工具注册
│   │       └── resource_registry.go   # 资源注册
│   ├── workflow/                      # 简单工作流
│   │   ├── engine.go                  # 工作流引擎
│   │   └── executor.go                # 执行器
│   ├── wecom/                         # 企业微信集成
│   │   ├── server.go                  # HTTP服务器
│   │   ├── handler.go                 # 消息处理器
│   │   ├── verifier.go                # 签名验证
│   │   └── types.go                   # 消息类型定义
│   └── config/                        # 配置管理
│       ├── config.go                  # 配置结构
│       └── loader.go                  # 配置加载器
├── internal/                          # 内部实现
│   └── models/                        # 数据模型
│       ├── wecom.go                   # 企业微信消息模型
│       └── session.go                 # 会话模型
├── docs/                              # 文档
│   ├── architecture.md                # 架构文档
│   ├── configuration.md               # 配置文档
│   ├── wecom-integration.md           # 企业微信集成文档
│   └── development.md                 # 开发文档
├── go.mod
├── go.sum
└── README.md
```

## 3. LLM多模型支持架构

### 3.1 设计原则
- **统一接口**：所有LLM提供商通过统一接口访问
- **配置驱动**：通过llm.yaml配置文件管理不同模型参数
- **工厂模式**：通过工厂创建不同的LLM提供商实例
- **agent-sdk-go适配**：无缝集成到agent-sdk-go框架

### 3.2 核心接口设计


### 3.3 提供商实现

#### 3.3.1 Qwen适配器
- **API集成**：直接调用阿里云通义千问API
- **消息转换**：将标准ChatRequest转换为Qwen API格式
- **响应处理**：统一响应格式，包含使用量统计
- **流式支持**：支持流式响应和实时输出

#### 3.3.2 DeepSeek适配器
- **OpenAI兼容**：使用OpenAI兼容的API接口
- **认证机制**：通过API Key进行身份验证
- **模型配置**：支持DeepSeek系列模型切换
- **错误处理**：统一的错误处理和重试机制

#### 3.3.3 Ollama适配器
- **本地部署**：连接本地Ollama服务
- **模型管理**：支持多种开源模型（llama2、mistral等）
- **性能优化**：针对本地推理的性能调优
- **资源监控**：监控本地资源使用情况



## 4. MCP客户端实现与外部工具集成

### 4.1 MCP客户端架构

AI-Body作为MCP客户端，连接和使用外部MCP服务器提供的工具、资源和提示词。完全遵循MCP协议规范，支持自动发现和动态集成外部能力。

#### 4.1.1 客户端层次结构

```
┌─────────────────────────────────────────┐
│           AI-Body Agent Application      │  
│         (Intelligence & Workflow)       │
├─────────────────────────────────────────┤
│              MCP Client Layer           │
│      (Tool Registry & Discovery)       │
├─────────────────────────────────────────┤
│             Protocol Layer              │
│     (MCP JSON-RPC 2.0 Messages)        │
├─────────────────────────────────────────┤
│             Transport Layer             │
│         (stdio / SSE Transport)         │
├─────────────────────────────────────────┤
│            External MCP Servers         │
│       (FileSystem/Database/Weather)     │
└─────────────────────────────────────────┘
```

#### 4.1.2 MCP客户端特性

- **协议标准化**：完全实现MCP 2024-11-05协议规范
- **传输多样性**：支持stdio和SSE两种传输方式
- **能力自动发现**：自动发现外部服务器的工具、资源、提示词
- **动态集成**：运行时动态注册和使用外部能力
- **健康监控**：持续监控外部服务器状态

### 4.2 MCP客户端核心组件

#### 4.2.1 客户端结构


#### 4.2.2 协议生命周期

1. **连接建立**：根据配置创建stdio或SSE传输连接
2. **初始化协商**：发送initialize请求，交换客户端和服务器能力
3. **能力发现**：查询服务器提供的工具、资源、提示词列表
4. **能力注册**：将发现的能力注册到本地工具注册表
5. **运行时调用**：通过标准MCP协议调用外部工具
6. **健康监控**：定期检查连接状态和服务器健康

### 4.3 自动发现服务

#### 4.3.1 发现服务架构



#### 4.3.2 发现流程

1. **配置加载**：读取mcp.json配置文件，获取外部服务器列表
2. **连接建立**：为每个配置的服务器创建MCP客户端连接
3. **能力协商**：与每个服务器进行初始化握手，交换能力信息
4. **工具发现**：通过`tools/list`请求获取服务器提供的工具列表
5. **资源发现**：通过`resources/list`请求获取可用资源
6. **提示词发现**：通过`prompts/list`请求获取提示词模板
7. **注册集成**：将发现的能力注册到本地工具注册表
8. **持续监控**：监控服务器状态，处理连接变化事件

#### 4.3.3 工具注册表

- **统一管理**：集中管理所有外部工具的元数据
- **快速查找**：支持按名称、服务器、类型快速查找工具
- **状态跟踪**：跟踪工具的可用性和健康状态
- **调用代理**：提供统一的工具调用接口

### 4.4 MCP配置文件


## 5. 简单工作流引擎设计

### 5.1 工作流架构概述

采用最简化的三步式工作流设计，专注于实际应用需求：

- **三步执行**：决策→工具调用（可选）→响应生成
- **智能决策**：大模型自动判断是否需要调用外部工具
- **线性流程**：简单的线性执行流程，易于理解和维护
- **配置驱动**：通过简单的配置定义工作流行为

### 5.2 工作流组件


### 5.3 三步执行流程

#### 步骤1：智能决策
- 大模型分析用户输入和当前上下文
- 判断是否需要调用外部MCP工具
- 如果需要，选择合适的工具和参数

#### 步骤2：工具调用（可选）
- 如果决策结果需要调用工具，则执行MCP工具调用
- 获取工具返回结果
- 更新执行上下文

#### 步骤3：响应生成
- 基于工具结果或直接基于用户输入生成回答
- 整合所有信息形成最终响应
- 返回结构化结果

### 5.4 决策机制

#### 5.4.1 决策逻辑

#### 5.4.2 决策原则
1. **信息获取需求**：如果用户请求需要获取实时信息或外部数据，则调用相应工具
2. **操作执行需求**：如果需要执行具体操作（文件操作、数据库查询等），则调用工具
3. **知识问答**：如果是一般性知识问答，则直接回答
4. **工具选择**：从可用工具中选择最合适的工具和参数

### 5.5 执行流程

#### 5.5.1 执行步骤
1. **接收用户输入**：获取用户请求和会话上下文
2. **决策分析**：大模型分析是否需要调用外部工具
3. **工具调用**：如果需要，调用选定的MCP工具
4. **响应生成**：基于结果生成最终回答
5. **结果返回**：返回结构化响应给用户

#### 5.5.2 工作流配置

## 6. 企业微信集成架构

### 6.1 企业微信机器人概述

#### 6.1.1 集成特性
- **HTTP回调接口**：接收企业微信推送的用户消息
- **安全验证机制**：支持签名验证和消息加密
- **XML消息格式**：处理企业微信标准的XML消息格式
- **用户会话管理**：基于企业微信用户ID的会话隔离
- **实时响应**：同步返回智能体回复消息

#### 6.1.2 消息流程

```
企业微信用户 ──> 企业微信平台 ──> AI-Body回调接口 ──> 智能体处理 ──> 返回回复 ──> 企业微信平台 ──> 企业微信用户
```

### 6.2 HTTP服务器设计

#### 6.2.1 服务器架构


#### 6.2.2 核心接口

- **GET /wecom/callback**：企业微信URL验证
- **POST /wecom/callback**：接收企业微信消息推送
- **GET /health**：服务健康检查

### 6.3 消息处理机制

#### 6.3.1 消息类型定义


#### 6.3.2 消息处理流程

1. **请求验证**：验证企业微信签名，确保请求合法性
2. **消息解析**：解析XML格式的消息内容
3. **会话管理**：基于用户ID创建或获取会话
4. **智能体调用**：将消息转发给智能体处理
5. **响应生成**：格式化响应为企业微信XML格式
6. **消息回复**：同步返回回复消息

### 6.4 安全验证机制

#### 6.4.1 签名验证



#### 6.4.2 消息加解密（可选）
- 支持企业微信消息加密模式
- AES加密算法处理敏感消息
- EncodingAESKey配置管理

### 6.5 配置管理


## 7. Agent-SDK-GO集成架构

### 7.1 集成策略

AI-Body通过适配器模式将各个组件无缝集成到agent-sdk-go框架：

- **LLM适配器**：将多种LLM提供商适配为agent-sdk-go的LLM接口
- **工具适配器**：将MCP客户端发现的外部工具适配为agent-sdk-go的工具接口
- **内存管理**：使用agent-sdk-go的对话缓冲区管理会话记忆
- **统一接口**：提供统一的智能体接口供企业微信调用

### 7.2 核心适配组件

`

### 7.3 会话管理

- **会话隔离**：基于企业微信用户ID的会话独立管理
- **对话历史**：保持企业微信会话内的对话历史和上下文
- **状态持久化**：支持会话状态的持久化存储
- **超时管理**：自动清理过期会话，释放资源

## 8. 配置管理

### 8.1 主配置文件

前面已在企业微信集成章节展示了app.yaml的配置，这里补充其他配置文件：



### 8.2 配置加载机制

- **环境变量支持**：敏感信息（如API密钥、Token）通过环境变量注入
- **配置验证**：启动时验证配置文件完整性和必需参数
- **默认值处理**：为所有配置项提供合理的默认值
- **错误处理**：配置加载失败时提供清晰的错误信息

## 9. 主程序设计

### 9.1 根目录main.go设计


### 9.2 启动流程

1. **配置加载**：读取并验证所有配置文件
2. **组件初始化**：按序初始化LLM、MCP、Agent、Workflow组件
3. **服务器启动**：启动HTTP服务器，开始接收企业微信回调
4. **健康检查**：确保所有组件正常运行
5. **优雅关闭**：监听系统信号，优雅关闭所有组件

## 10. 总结

### 10.1 架构特点

本架构设计专注于企业微信智能机器人的核心需求，具有以下特点：

1. **企业微信专用**：专为企业微信平台设计，支持标准的回调接口和消息格式
2. **简洁高效**：采用简化的三步式工作流和单一HTTP接口，易于理解和维护
3. **标准化集成**：完整实现MCP协议，支持外部工具的标准化集成
4. **多模型支持**：统一接口支持多种LLM提供商，便于切换和扩展
5. **智能决策**：大模型自动判断是否需要调用外部工具，提高响应效率

### 10.2 技术优势

- **模块化设计**：各组件独立，职责清晰，便于开发和测试
- **配置驱动**：通过配置文件管理所有参数，无需前端界面
- **安全可靠**：支持企业微信签名验证和消息加密
- **扩展性良好**：预留接口支持新的LLM提供商和MCP工具
- **部署简单**：单一可执行文件，配置文件驱动

### 10.3 核心价值

- **降低开发复杂度**：统一的智能体框架简化了AI应用开发
- **提高集成效率**：标准化的MCP协议支持快速集成外部工具
- **增强用户体验**：智能决策机制提供更准确的回复
- **保障企业安全**：完整的验证机制确保企业微信集成安全

### 10.4 适用场景

该架构特别适用于以下企业场景：

- **企业内部助手**：为企业员工提供智能问答和任务处理
- **客服机器人**：自动回复客户咨询，提供24小时服务
- **知识管理**：结合企业内部知识库提供智能检索
- **工作流自动化**：通过MCP工具集成企业内部系统，实现任务自动化

通过这个专门为企业微信设计的智能机器人架构，企业可以快速部署功能强大、安全可靠的AI服务。